apiVersion: batch/v1
kind: Job
metadata:
  name: kafka-topics-init
  namespace: workload-demo
spec:
  template:
    spec:
      restartPolicy: OnFailure
      containers:
        - name: init
          image: bitnami/kafka:3.7.0
          command:
            - bash
            - -lc
            - |
              set -e
              echo "Waiting for Kafka..."
              for i in {1..60}; do
                /opt/bitnami/kafka/bin/kafka-topics.sh --bootstrap-server kafka:9092 --list >/dev/null 2>&1 && break
                sleep 2
              done
              echo "Creating topics (idempotent)..."
              for t in jobs.in jobs.light jobs.heavy; do
                /opt/bitnami/kafka/bin/kafka-topics.sh --bootstrap-server kafka:9092 --create --if-not-exists --topic "$t" --partitions 3 --replication-factor 1
              done
              echo "Done."
